<odoo>
  <record id="view_crm_lead_form_custom" model="ir.ui.view">
    <field name="name">crm.lead.form.custom</field>
    <field name="model">crm.lead</field>
    <field name="inherit_id" ref="crm.crm_lead_view_form"/>
    <field name="arch" type="xml">

      <xpath expr="//notebook" position="inside">

        <!-- Página de Servicios - UNA SOLA LISTA -->
        <page string="Gestión de Servicio" name="residuos">
          <separator string="Listado de Servicios/Residuos"/>
          
          <group>
            <field name="residue_line_ids" nolabel="1">
              <!-- Usamos list (sintaxis v19) editable bottom -->
              <list editable="bottom" decoration-info="create_new_service==True">
                
                <!-- 1. Lógica SERVICIO -->
                <field name="create_new_service" 
                       string="Nuevo" 
                       widget="boolean_toggle" 
                       width="60px"/>
                
                <!-- Opción A: Escribir nombre (Visible si Nuevo=True) -->
                <field name="name" 
                       string="Nombre"
                       invisible="not create_new_service"
                       required="create_new_service"
                       placeholder="Nombre del nuevo residuo..."
                       whidth="80px"
                       />
                
                <!-- Opción B: Seleccionar existente (Visible si Nuevo=False) -->
                <field name="existing_service_id"
                       string="Existente"
                       domain="[('sale_ok','=',True), ('type','=','service')]"
                       options="{'no_create': True, 'no_open': True}"
                       invisible="create_new_service"
                       required="not create_new_service"
                       placeholder="Buscar servicio..." whidth="80px"/>
                
                <!-- Campos Informativos -->
                <field name="residue_type" string="Tipo" optional="show"/>
                <field name="plan_manejo" string="Manejo" optional="show"/>

                <!-- 2. Lógica EMBALAJE -->
                <field name="create_new_packaging" 
                       string="Nuevo Emb." 
                       widget="boolean_toggle"
                       width="90px"/>
                
                <!-- Opción A: Escribir nuevo embalaje (Visible si NuevoEmb=True) -->
                <field name="packaging_name" 
                       string="Nombre Embalaje" 
                       invisible="not create_new_packaging"
                       required="create_new_packaging"
                       placeholder="Ej: Tambor 200L"
                       width="80px"/>
                
                <!-- Opción B: Seleccionar existente (Visible si NuevoEmb=False) -->
                <field name="packaging_id" 
                       string="Emb. Existente" 
                       options="{'no_create': True}"
                       invisible="create_new_packaging"
                       required="not create_new_packaging"
                       placeholder="Seleccionar..."
                       whidth="80px"/>

                <!-- Medidas y Totales -->
                <field name="capacity" string="Capacidad"/>
                <field name="weight_kg" string="Peso(kg)"/>
                <field name="volume" string="Unidades"/>
                <field name="weight_per_unit" string="Kg/Unidad" readonly="1" optional="hide"/>
                <field name="uom_id" string="UoM" optional="hide"/>
                
                <!-- Servicio asociado (Oculto en lista, útil para botón) -->
                <field name="product_id" column_invisible="True"/>
                
                <button name="%(product.product_template_action)d"
                        type="action"
                        icon="fa-external-link"
                        title="Ver servicio"
                        context="{'search_default_id': product_id}"
                        invisible="not product_id"/>
              </list>
            </field>
          </group>
        </page>

        <!-- Página de Validación de Residuos -->
        <page string="Validación de Residuos" name="residue_validation">
          <group string="Validación de Residuo Nuevo">
            <field name="residue_new"/>
            <div invisible="not show_sample_alert" style="margin: 10px 0;">
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-warning"/>
                <strong>Atención:</strong> Se requiere solicitar muestra al cliente para análisis.
              </div>
            </div>
            <field name="sample_result_file" filename="sample_result_filename" widget="pdf_viewer" invisible="not residue_new" options="{'force_save': True}"/>
            <field name="sample_result_filename" invisible="1"/>
          </group>

          <group string="Validación de Visita Presencial">
            <field name="requiere_visita"/>
            <div invisible="not show_visita_alert" style="margin: 10px 0;">
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-warning"/>
                <strong>Atención:</strong> Se requiere validar residuos y volúmenes en sitio y subir el informe correspondiente.
              </div>
            </div>
            <field name="visita_validation_file" filename="visita_validation_filename" widget="pdf_viewer" invisible="not requiere_visita" options="{'force_save': True}"/>
            <field name="visita_validation_filename" invisible="1"/>
          </group>

          <field name="show_sample_alert" invisible="1"/>
          <field name="show_visita_alert" invisible="1"/>
        </page>

        
        <!-- Página de Información del Servicio -->
        <page string="Información del Servicio" name="service_info">
          <group>
            <group string="Detalles del Servicio">
              
              <field name="pickup_location_id"
                    widget="res_partner_many2one"
                    context="{
                        'default_parent_id': partner_id,
                        'default_type': 'delivery',
                        'show_address': 1
                    }"
                    domain="['|', ('parent_id', '=', partner_id), ('id', '=', partner_id)]"
                    options="{'always_reload': True, 'no_quick_create': True}"
                    placeholder="Seleccionar dirección de entrega..."
                    invisible="not partner_id"
              />
              <!-- Nota: He puesto invisible="not partner_id" porque para crear una dirección hija, 
                   primero necesitas haber seleccionado al Cliente (partner_id) en el encabezado del Lead -->

              <field name="service_frequency"/>
            </group>
          </group>
        </page>

        <!-- Página de Información del Prospecto -->
        <page string="Información del Prospecto" name="prospect_info">
          <group>
            <group string="Información Básica del Prospecto">
              <field name="company_size"/>
              <field name="industrial_sector"/>
            </group>
            <group string="Clasificación Comercial">
              <field name="prospect_priority"/>
              <field name="estimated_business_potential"/>
            </group>
          </group>
        </page>

        <!-- Página de Información Operativa -->
        <page string="Información Operativa" name="operational_info">
          <group col="2">
            <group string="Accesos y Restricciones">
              <field name="access_restrictions" widget="text"/>
              <field name="special_handling_conditions" widget="text"/>
            </group>

            <group string="Operación y Logística">
              <field name="allowed_collection_schedules" widget="text"/>
              <field name="current_container_types" widget="text"/>
              <field name="seasonality" widget="text"/>
            </group>
          </group>
        </page>


        <!-- Página de Información Regulatoria -->
        <page string="Información Regulatoria" name="regulatory_info">
          <group col="2">
            <group string="Registros y Autorizaciones">
              <field name="waste_generator_registration"/>
              <field name="environmental_authorizations" widget="text"/>
            </group>

            <group string="Certificaciones y Permisos">
              <field name="quality_certifications" widget="text"/>
              <field name="other_relevant_permits" widget="text"/>
            </group>
          </group>
        </page>


        <!-- Página de Competencia y Mercado -->
        <page string="Competencia y Mercado" name="competition_market">
          <group col="2">
            <group string="Proveedor Actual">
              <field name="current_service_provider"/>
              <field name="current_provider_satisfaction"/>
            </group>

            <group string="Costos y Motivo de Cambio">
              <field name="current_costs"/>
              <field name="reason_for_new_provider" widget="text"/>
            </group>
          </group>
        </page>


        <!-- Página de Requerimientos Especiales -->
        <page string="Requerimientos Especiales" name="special_requirements">
          <group col="2">
            <group string="Documentación y Reporteo">
              <field name="specific_certificates_needed" widget="text"/>
              <field name="reporting_requirements" widget="text"/>
            </group>

            <group string="Prioridad y Presupuesto">
              <field name="service_urgency"/>
              <field name="estimated_budget"/>
            </group>
          </group>
        </page>


        <!-- Página de Seguimiento -->
        <page string="Seguimiento" name="seguimiento">
          <group col="2">
            <group string="Próximo Contacto">
              <field name="next_contact_date"/>
              <field name="pending_actions" widget="text"/>
            </group>

            <group string="Notas de Conversación">
              <field name="conversation_notes" widget="text"/>
            </group>
          </group>
        </page>


      </xpath>
    </field>
  </record>
</odoo>