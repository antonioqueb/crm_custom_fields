<odoo>
  <record id="view_crm_lead_form_custom" model="ir.ui.view">
    <field name="name">crm.lead.form.custom</field>
    <field name="model">crm.lead</field>
    <field name="inherit_id" ref="crm.crm_lead_view_form"/>
    <field name="arch" type="xml">

      <xpath expr="//notebook" position="inside">

        <!-- Página de Validación de Residuos -->
        <page string="Validación de Residuos" name="residue_validation">
          <group string="Validación de Residuo Nuevo">
            <field name="residue_new"/>
            <div invisible="not show_sample_alert" style="margin: 10px 0;">
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-warning"/>
                <strong>Atención:</strong> Se requiere solicitar muestra al cliente para análisis.
              </div>
            </div>
            <field name="sample_result_file" filename="sample_result_filename" widget="pdf_viewer" invisible="not residue_new" options="{'force_save': True}"/>
            <field name="sample_result_filename" invisible="1"/>
          </group>

          <group string="Validación de Visita Presencial">
            <field name="requiere_visita"/>
            <div invisible="not show_visita_alert" style="margin: 10px 0;">
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-warning"/>
                <strong>Atención:</strong> Se requiere validar residuos y volúmenes en sitio y subir el informe correspondiente.
              </div>
            </div>
            <field name="visita_validation_file" filename="visita_validation_filename" widget="pdf_viewer" invisible="not requiere_visita" options="{'force_save': True}"/>
            <field name="visita_validation_filename" invisible="1"/>
          </group>

          <field name="show_sample_alert" invisible="1"/>
          <field name="show_visita_alert" invisible="1"/>
        </page>

        <!-- Página de Servicios - UNA SOLA LISTA -->
        <page string="Gestión de Servicio" name="residuos">
          <separator string="Listado de Servicios y Residuos"/>
          
          <group>
            <field name="residue_line_ids" nolabel="1">
              <list editable="bottom">
                <!-- Checkbox para identificar si es nuevo -->
                <field name="create_new_service" string="¿Nuevo?"/>
                
                <!-- Campo para seleccionar servicio existente (visible cuando NO es nuevo) -->
                <field name="existing_service_id"
                       string="Servicio Existente"
                       domain="[('sale_ok','=',True), ('type','=','service')]"
                       options="{'no_create': True}"
                       optional="show"/>
                
                <!-- Campos SIEMPRE EDITABLES -->
                <field name="name" string="Nombre"/>
                <field name="residue_type" string="Tipo"/>
                <field name="plan_manejo" string="Plan de Manejo"/>
                <field name="capacity" string="Capacidad"/>
                <field name="weight_kg" string="Peso (kg)"/>
                <field name="volume" string="Unidades"/>
                <field name="weight_per_unit" string="Kg/Unidad" readonly="1"/>
                <field name="uom_id" string="UoM"/>
                
                <!-- NUEVO: Campo de texto para nombre del embalaje -->
                <field name="packaging_name" string="Nombre Embalaje"/>
                
                <!-- Embalaje creado (solo lectura) -->
                <field name="packaging_id" string="Embalaje" readonly="1" optional="show"/>
                
                <!-- Servicio asociado (solo lectura) -->
                <field name="product_id" string="Servicio" readonly="1" optional="show"/>
                
                <button name="%(product.product_template_action)d"
                        type="action"
                        icon="fa-external-link"
                        title="Ver servicio"
                        context="{'search_default_id': product_id}"
                        invisible="not product_id"/>
              </list>

              <form>
                <group>
                  <group string="Tipo de Servicio">
                    <field name="create_new_service"/>
                    
                    <!-- Selección de servicio existente -->
                    <field name="existing_service_id"
                           string="Servicio Existente"
                           domain="[('sale_ok','=',True), ('type','=','service')]"
                           options="{'no_create': True}"
                           placeholder="Buscar servicio existente..."
                           invisible="create_new_service"
                           required="not create_new_service"/>
                  </group>
                  
                  <group string="Información del Servicio/Residuo">
                    <field name="name" required="1"/>
                    <field name="residue_type"/>
                    <field name="plan_manejo"/>
                    <field name="product_id" readonly="1"/>
                  </group>
                </group>
                
                <group string="Cantidades, Capacidad y Peso">
                  <group>
                    <field name="capacity"/>
                    <field name="weight_kg"/>
                    <field name="volume"/>
                    <field name="weight_per_unit" readonly="1"/>
                  </group>
                  <group>
                    <field name="uom_id"/>
                  </group>
                </group>
                
                <group string="Embalaje">
                  <group>
                    <field name="packaging_name" 
                           placeholder="Escribe el nombre del embalaje (ej: Tambor 200L, Contenedor IBC, Bolsa 50kg)"
                           help="Escribe el nombre y se creará automáticamente al guardar"/>
                    <field name="packaging_id" readonly="1"/>
                  </group>
                </group>
              </form>
            </field>
          </group>
        </page>

        <!-- Página de Información del Servicio -->
        <page string="Información del Servicio" name="service_info">
          <group>
            <group string="Detalles del Servicio">
              <field name="pickup_location"/>
              <field name="service_frequency"/>
            </group>
          </group>
        </page>

        <!-- Página de Información del Prospecto -->
        <page string="Información del Prospecto" name="prospect_info">
          <group>
            <group string="Información Básica del Prospecto">
              <field name="company_size"/>
              <field name="industrial_sector"/>
            </group>
            <group string="Clasificación Comercial">
              <field name="prospect_priority"/>
              <field name="estimated_business_potential"/>
            </group>
          </group>
        </page>

        <!-- Página de Información Operativa -->
        <page string="Información Operativa" name="operational_info">
          <group>
            <group string="Condiciones Operativas">
              <field name="access_restrictions" widget="text"/>
              <field name="allowed_collection_schedules" widget="text"/>
              <field name="current_container_types" widget="text"/>
              <field name="special_handling_conditions" widget="text"/>
              <field name="seasonality" widget="text"/>
            </group>
          </group>
        </page>

        <!-- Página de Información Regulatoria -->
        <page string="Información Regulatoria" name="regulatory_info">
          <group>
            <group string="Registros y Autorizaciones">
              <field name="waste_generator_registration"/>
              <field name="environmental_authorizations" widget="text"/>
            </group>
            <group>
              <field name="quality_certifications" widget="text"/>
              <field name="other_relevant_permits" widget="text"/>
            </group>
          </group>
        </page>

        <!-- Página de Competencia y Mercado -->
        <page string="Competencia y Mercado" name="competition_market">
          <group>
            <group string="Proveedor Actual">
              <field name="current_service_provider"/>
              <field name="current_costs"/>
              <field name="current_provider_satisfaction"/>
              <field name="reason_for_new_provider" widget="text"/>
            </group>
          </group>
        </page>

        <!-- Página de Requerimientos Especiales -->
        <page string="Requerimientos Especiales" name="special_requirements">
          <group>
            <group string="Requerimientos del Cliente">
              <field name="specific_certificates_needed" widget="text"/>
              <field name="reporting_requirements" widget="text"/>
              <field name="service_urgency"/>
              <field name="estimated_budget"/>
            </group>
          </group>
        </page>

        <!-- Página de Seguimiento -->
        <page string="Seguimiento" name="seguimiento">
          <group>
            <group string="Gestión de Seguimiento">
              <field name="next_contact_date"/>
              <field name="pending_actions" widget="text"/>
              <field name="conversation_notes" widget="text"/>
            </group>
          </group>
        </page>

      </xpath>
    </field>
  </record>
</odoo>